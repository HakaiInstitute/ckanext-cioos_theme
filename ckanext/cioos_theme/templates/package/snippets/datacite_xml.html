<?xml version="1.0" encoding="UTF-8"?>
<resource xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://datacite.org/schema/kernel-4" xsi:schemaLocation="http://datacite.org/schema/kernel-4 http://schema.datacite.org/meta/kernel-4.1/metadata.xsd">
  {% if "doi" in pkg.get('unique-resource-identifier-full',{}).get('code') or "code" in pkg.get('unique-resource-identifier-full',{}).get('code')-%}
  <identifier identifierType="DOI">{{ pkg.get('unique-resource-identifier-full',{}).get('code') }}</identifier>
  {%- endif -%}
  <creators>
    {% for party in h.cioos_load_json(pkg['cited-responsible-party']) %}
      {%- if party['individual-name'] -%}
      <creator>
        {%- if ',' in party['individual-name'] -%}
          {% set names = party['individual-name'].split(',') -%}
          <creatorName nameType="Personal">{{ party['individual-name'] }}</creatorName>
          <givenName>{{ names[1].strip() }}</givenName>
          <familyName>{{ names[0] }}</familyName>
        {% else %}
          {% set names = party['individual-name'].split(' ') -%}
          <creatorName nameType="Personal">{{ names[-1] }} {%- if names[:-1] -%}, {{' '.join(names[:-1])}} {%- endif %}</creatorName>
          <givenName>{{ ' '.join(names[:-1]) or names[0] }}</givenName>
          <familyName>{{ names[-1] }}</familyName>
        {% endif %}
        {% if party['organisation-name'] -%}
        <affiliation>{{party['organisation-name']}}</affiliation>
        {%- endif %}
      </creator>
      {% endif %}
    {%- endfor -%}
  </creators>
  <titles>
    <title xml:lang="en">{{ pkg['title_translated']['en'] or pkg['title_translated'] }}</title>
    <title xml:lang="fr">{{ pkg['title_translated']['fr'] or pkg['title_translated'] }}</title>
  </titles>
  {%- for party in h.cioos_load_json(pkg['cited-responsible-party']) -%}
    {% if 'publisher' in party['role'] or 'role' in party['role']%}
  <publisher>{{ party['organisation-name'] or party['individual-name'] }}</publisher>
    {% endif %}
  {%- endfor -%}

  {%- for date in h.cioos_load_json(pkg['dataset-reference-date']) -%}
    {% if 'publication' in date['type'] %}
  <publicationYear>{{ date['value'][0:4] }}</publicationYear>
    {% elif 'type' in date['type'] %}
    {# the elif is to populate template for schemamap #}
  <publicationYear>{{ date['value'] }}</publicationYear>
    {% endif %}
  {%- endfor -%}
  <subjects>
    {%- for kw in pkg['keywords']['en'] or pkg['keywords'] %}
    <subject xml:lang="en">{{ kw }}</subject>
    {%- endfor %}
    {%- for kw in pkg['keywords']['fr'] or pkg['keywords'] %}
    <subject xml:lang="fr">{{ kw }}</subject>
    {%- endfor %}
  </subjects>

  {%- if pkg['distributor'] %}
  <contributors>
    {%- for party in h.cioos_load_json(pkg['distributor']) %}
    <contributor contributorType="{{party['role'][0]|title}}">
      {%- if ',' in party['individual-name'] -%}
        {% set names = party['individual-name'].split(',') -%}
        <creatorName nameType="Personal">{{ party['individual-name'] }}</creatorName>
        <givenName>{{ names[1].strip() }}</givenName>
        <familyName>{{ names[0] }}</familyName>
      {% elif party['individual-name'] -%}
        {% set names = party['individual-name'].split(' ') -%}
      {% else %}
        {% set names = party['organisation-name'].split(' ') -%}
      {%- endif %}
      <contributorName>{{ names[-1] }} {%- if names[:-1] -%}, {{' '.join(names[:-1])}} {%- endif %}</contributorName>
      <givenName>{{ ' '.join(names[:-1]) or names[0] }}</givenName>
      <familyName>{{ names[-1] }}</familyName>
      {% if party['organisation-name'] and party['individual-name']-%}
      <affiliation>{{party['organisation-name']}}</affiliation>
      {%- endif %}
    </contributor>
    {%- endfor %}
  </contributors>
  {% endif -%}

  <language>{{ pkg['metadata-language'] }}</language>
  <resourceType resourceTypeGeneral="{{ pkg['resource-type'].title() }}">{{ pkg['resource-type'].title() }}</resourceType>
  <version>{{pkg['version'] or '1.0' }}</version>
  {%- if pkg['license_url'] and pkg['license_title'] %}
  <rightsList>
    <rights xml:lang="en-US" rightsURI="{{ pkg['license_url'] }}">{{ pkg['license_title'] }}</rights>
  </rightsList>
  {% endif -%}
  <descriptions>
    <description xml:lang="en" descriptionType="Abstract">
      {{- pkg['notes_translated']['en'] or pkg['notes_translated'] -}}
    </description>
    <description xml:lang="fr" descriptionType="Abstract">
      {{- pkg['notes_translated']['fr'] or pkg['notes_translated'] -}}
    </description>
  </descriptions>

  <geoLocations>
    <geoLocation>
      <geoLocationBox>
        <westBoundLongitude>{{pkg['bbox-west-long']}}</westBoundLongitude>
        <eastBoundLongitude>{{pkg['bbox-east-long']}}</eastBoundLongitude>
        <southBoundLatitude>{{pkg['bbox-south-lat']}}</southBoundLatitude>
        <northBoundLatitude>{{pkg['bbox-north-lat']}}</northBoundLatitude>
      </geoLocationBox>
      {% set spatial = h.cioos_load_json(pkg['spatial']) %}
      {%- if spatial and spatial['type'] == 'Polygon' %}
      <geoLocationPolygon>
        {%- for coord in spatial['coordinates'][0] %}
        <polygonPoint>
          <pointLatitude>{{coord[1]}}</pointLatitude>
          <pointLongitude>{{coord[0]}}</pointLongitude>
        </polygonPoint>
        {%- endfor %}
      </geoLocationPolygon>
      {%- endif %}
    </geoLocation>
  </geoLocations>

</resource>
